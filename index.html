<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµç è½¬ä¸– - äº”å­è¿ç æ¸¸æˆ</title>
    <link rel="stylesheet" href="game.css">
</head>
<body>
    <div id="menu" class="container">
        <h1>çµç è½¬ä¸–</h1>
        <button class="menu-button" id="startGame">å¼€å§‹æ¸¸æˆ</button>
        <button class="menu-button" id="showRules">æ¸¸æˆè§„åˆ™</button>
        <button class="menu-button" id="showSettings">æ¸¸æˆè®¾ç½®</button>
        <button class="menu-button" id="showRanking">æ¸¸æˆæ’è¡Œ</button>
    </div>

    <div id="gameScreen" class="game-container" style="display: none;">
        <div id="pauseOverlay" class="pause-overlay" onclick="togglePause()">
            <div class="pause-icon"></div>
        </div>
        <div class="game-info">
            <div class="info-item">
                <div class="info-label">åˆ†æ•°</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">ç­‰çº§</div>
                <div class="info-value" id="level">1</div>
            </div>
        </div>

        <div class="next-balls" id="nextBalls"></div>
        <div class="game-board" id="gameBoard"></div>

        <div class="game-controls">
            <button id="pauseGame" class="control-button">æš‚åœ</button>
            <button id="restartGame" class="control-button">é‡æ–°å¼€å§‹</button>
            <button id="backToMenu" class="control-button">è¿”å›èœå•</button>
        </div>
    </div>

    <script src="game.js"></script>
    <script>
        let game = null;
        const menu = document.getElementById('menu');
        const gameScreen = document.getElementById('gameScreen');
        const gameBoard = document.getElementById('gameBoard');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const nextBallsElement = document.getElementById('nextBalls');
        const pauseButton = document.getElementById('pauseGame');

        // æš‚åœ/ç»§ç»­æ¸¸æˆ
        function togglePause() {
            if (!game) return;
            const isPaused = game.togglePause();
            const pauseButton = document.getElementById('pauseGame');
            const pauseOverlay = document.getElementById('pauseOverlay');
            const gameBoard = document.getElementById('gameBoard');
            
            pauseButton.textContent = isPaused ? 'ç»§ç»­' : 'æš‚åœ';
            gameBoard.style.pointerEvents = isPaused ? 'none' : 'auto';
            pauseOverlay.style.display = isPaused ? 'flex' : 'none';
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            const gameOver = document.querySelector('.game-over');
            if (gameOver) {
                gameOver.remove();
            }
            if (game) {
                game.reset();
                updateGameView();
                pauseButton.textContent = 'æš‚åœ';
                gameBoard.style.pointerEvents = 'auto';
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('pauseGame').addEventListener('click', togglePause);
        document.getElementById('restartGame').addEventListener('click', restartGame);

        // åˆå§‹åŒ–æ¸¸æˆæ£‹ç›˜
        function initializeBoard() {
            gameBoard.innerHTML = '';
            for (let y = 0; y < 9; y++) {
                for (let x = 0; x < 9; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.addEventListener('click', handleCellClick);
                    gameBoard.appendChild(cell);
                }
            }
        }

        // æ›´æ–°æ¸¸æˆç•Œé¢
        function updateGameView() {
            // æ›´æ–°åˆ†æ•°å’Œç­‰çº§
            scoreElement.textContent = game.score;
            levelElement.textContent = game.level;
        
            // æ›´æ–°æ£‹ç›˜
            const cells = gameBoard.getElementsByClassName('cell');
            for (let y = 0; y < game.boardSize; y++) {
                for (let x = 0; x < game.boardSize; x++) {
                    const cell = cells[y * game.boardSize + x];
                    const color = game.board[y][x];
                    
                    // æ¸…é™¤ç°æœ‰çš„ç å­
                    cell.innerHTML = '';
                    cell.classList.remove('selected');
                    
                    // å¦‚æœæœ‰ç å­ï¼Œåˆ›å»ºå¹¶æ·»åŠ ç å­å…ƒç´ 
                    if (color) {
                        const ball = document.createElement('div');
                        ball.className = `ball ${color}`;
                        cell.appendChild(ball);
                        
                        // å¦‚æœæ˜¯é€‰ä¸­çš„ç å­ï¼Œæ·»åŠ é€‰ä¸­æ•ˆæœ
                        if (game.selectedBall && 
                            game.selectedBall[0] === x && 
                            game.selectedBall[1] === y) {
                            cell.classList.add('selected');
                        }
                    }
                }
            }

            // æ›´æ–°ä¸‹ä¸€å›åˆæç¤ºæ–‡å­—å’Œç å­
            const nextBallsText = document.createElement('div');
            nextBallsText.className = 'next-balls-text';
            nextBallsText.textContent = 'ä¸‹ä¸€å›åˆ';
            nextBallsElement.innerHTML = '';
            nextBallsElement.appendChild(nextBallsText);

            // åˆ›å»ºä¸‹ä¸€å›åˆçš„ç å­é¢„è§ˆ
            const nextBallsPreview = document.createElement('div');
            nextBallsPreview.className = 'next-balls-preview';
            for (let i = 0; i < 3; i++) {
                const nextBall = document.createElement('div');
                nextBall.className = `ball ${game.nextBalls[i].color}`;
                nextBallsPreview.appendChild(nextBall);
            }
            nextBallsElement.appendChild(nextBallsPreview);
        }

        // å¤„ç†æ ¼å­ç‚¹å‡»äº‹ä»¶
        function handleCellClick(event) {
            const cell = event.currentTarget;
            const x = parseInt(cell.dataset.x);
            const y = parseInt(cell.dataset.y);

            if (game.board[y][x] !== null) {
                // é€‰æ‹©ç å­
                if (game.selectedBall) {
                    const [selectedX, selectedY] = game.selectedBall;
                    if (selectedX === x && selectedY === y) {
                        game.selectedBall = null;
                    } else {
                        game.selectedBall = [x, y];
                    }
                } else {
                    game.selectedBall = [x, y];
                }
            } else if (game.selectedBall) {
                // ç§»åŠ¨ç å­
                const [fromX, fromY] = game.selectedBall;
                if (game.moveBall(fromX, fromY, x, y)) {
                    // åˆ›å»ºç§»åŠ¨è½¨è¿¹åŠ¨ç”»
                    createMovePathAnimation(fromX, fromY, x, y);
                    
                    // ç§»åŠ¨å®Œæˆåæ£€æŸ¥æ˜¯å¦æœ‰å¯æ¶ˆé™¤çš„ç å­
                    setTimeout(() => {
                        game.selectedBall = null;
                        const lines = game.checkLines();
                        
                        if (lines.length > 0) {
                            // ä¸ºæ¯ä¸ªç å­æ·»åŠ æ¶ˆé™¤åŠ¨ç”»
                            for (const line of lines) {
                                for (const [x, y] of line) {
                                    const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                                    const ball = cell.querySelector('.ball');
                                    if (ball) {
                                        ball.classList.add('removing');
                                    }
                                }
                            }
                            
                            // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†ç§»é™¤ç å­å¹¶æ·»åŠ æ–°ç å­
                            setTimeout(() => {
                                // è®¡ç®—æ€»å…±æ¶ˆé™¤çš„ç å­æ•°é‡
                                let totalRemoved = 0;
                                for (const line of lines) {
                                    totalRemoved += line.length;
                                }
                                
                                game.removeBalls(lines);
                                game.addNewBalls(); // æ·»åŠ æ–°çš„ç å­
                                updateGameView(); // æ›´æ–°æ¸¸æˆè§†å›¾
                                
                                // æ·»åŠ ç²’å­ç‰¹æ•ˆï¼ˆé’ˆå¯¹5è¿åŠä»¥ä¸Šï¼‰
                                if(totalRemoved >= 5) {
                                    lines.forEach(line => {
                                        line.forEach(([x, y]) => {
                                            const cell = document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
                                            createExplosionEffect(cell, line.length);
                                        });
                                    });
                                }
                                
                                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                                if (game.isGameOver()) {
                                    // è§¦å‘ç²’å­çˆ†ç‚¸æ•ˆæœ
                                    createParticleEffect();
                                    
                                    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿åŠ¨ç”»æ’­æ”¾
                                    setTimeout(() => {
                                        // æ·»åŠ æ£‹ç›˜æ¶ˆå¤±åŠ¨ç”»
                                        gameBoard.classList.add('ending');
                                        
                                        // æ˜¾ç¤ºç»“æŸç•Œé¢
                                        showGameOver();
                                        
                                        // ç¦ç”¨æ£‹ç›˜ç‚¹å‡»
                                        document.querySelectorAll('.cell').forEach(cell => {
                                            cell.style.pointerEvents = 'none';
                                        });
                                    }, 800);
                                }
                            }, 600);
                        } else {
                            // å¦‚æœæ²¡æœ‰å¯æ¶ˆé™¤çš„ç å­ï¼Œç›´æ¥æ·»åŠ æ–°çš„ç å­
                            game.addNewBalls();
                            updateGameView(); // æ›´æ–°æ¸¸æˆè§†å›¾
                        }
                    }, 300);
                }
            }
            updateGameView();
        }
        
        // åˆ›å»ºç å­ç§»åŠ¨è½¨è¿¹åŠ¨ç”»
        function createMovePathAnimation(fromX, fromY, toX, toY) {
            // è·å–èµ·ç‚¹å’Œç»ˆç‚¹çš„ä½ç½®
            const fromCell = document.querySelector(`.cell[data-x="${fromX}"][data-y="${fromY}"]`);
            const toCell = document.querySelector(`.cell[data-x="${toX}"][data-y="${toY}"]`);
            
            if (!fromCell || !toCell) return;
            
            const fromRect = fromCell.getBoundingClientRect();
            const toRect = toCell.getBoundingClientRect();
            
            // è®¡ç®—è·¯å¾„
            const path = findPath(fromX, fromY, toX, toY);
            
            // åˆ›å»ºè½¨è¿¹åŠ¨ç”»
            for (let i = 0; i < path.length - 1; i++) {
                const [x1, y1] = path[i];
                const [x2, y2] = path[i + 1];
                
                const cell1 = document.querySelector(`.cell[data-x="${x1}"][data-y="${y1}"]`);
                const cell2 = document.querySelector(`.cell[data-x="${x2}"][data-y="${y2}"]`);
                
                if (cell1 && cell2) {
                    const rect1 = cell1.getBoundingClientRect();
                    const rect2 = cell2.getBoundingClientRect();
                    
                    // åˆ›å»ºè½¨è¿¹ç‚¹
                    const dot = document.createElement('div');
                    dot.className = 'path-dot';
                    cell1.appendChild(dot);
                    
                    // åˆ›å»ºè½¨è¿¹çº¿
                    const line = document.createElement('div');
                    line.className = 'path-line';
                    
                    // è®¡ç®—çº¿çš„é•¿åº¦å’Œè§’åº¦
                    const dx = rect2.left - rect1.left;
                    const dy = rect2.top - rect1.top;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    // è®¾ç½®çº¿çš„æ ·å¼
                    line.style.width = `${length}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    line.style.left = `${rect1.width / 2}px`;
                    line.style.top = `${rect1.height / 2}px`;
                    
                    cell1.appendChild(line);
                    
                    // è‡ªåŠ¨æ¸…ç†åŠ¨ç”»å…ƒç´ 
                    setTimeout(() => {
                        if (dot.parentNode) dot.parentNode.removeChild(dot);
                        if (line.parentNode) line.parentNode.removeChild(line);
                    }, 800);
                }
            }
        }
        
        // ä½¿ç”¨BFSå¯»æ‰¾è·¯å¾„
        function findPath(fromX, fromY, toX, toY) {
            const queue = [[fromX, fromY]];
            const visited = new Set();
            visited.add(`${fromX},${fromY}`);
            const parent = {};
            
            while (queue.length > 0) {
                const [x, y] = queue.shift();
                if (x === toX && y === toY) {
                    // æ‰¾åˆ°è·¯å¾„ï¼Œå›æº¯
                    const path = [];
                    let current = `${toX},${toY}`;
                    while (current) {
                        const [cx, cy] = current.split(',').map(Number);
                        path.unshift([cx, cy]);
                        current = parent[current];
                    }
                    return path;
                }
                
                // æ£€æŸ¥å››ä¸ªæ–¹å‘
                const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
                for (const [dx, dy] of directions) {
                    const newX = x + dx;
                    const newY = y + dy;
                    const key = `${newX},${newY}`;
                    
                    if (newX >= 0 && newX < game.boardSize &&
                        newY >= 0 && newY < game.boardSize &&
                        (game.board[newY][newX] === null || (newX === toX && newY === toY)) &&
                        !visited.has(key)) {
                        queue.push([newX, newY]);
                        visited.add(key);
                        parent[key] = `${x},${y}`;
                    }
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è·¯å¾„ï¼Œè¿”å›ç›´çº¿è·¯å¾„
            return [[fromX, fromY], [toX, toY]];
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸå¼¹çª—
        function showGameOver() {
            const gameOver = document.createElement('div');
            gameOver.className = 'game-over';
            gameOver.innerHTML = `
                <h2>æ¸¸æˆç»“æŸ</h2>
                <p>æœ€ç»ˆå¾—åˆ†: ${game.score}</p>
                <button onclick="restartGame()">é‡æ–°å¼€å§‹</button>
            `;
            document.body.appendChild(gameOver);
        }

        // ç²’å­æ•ˆæœç”Ÿæˆå™¨
        function createParticleEffect() {
            const boardRect = document.querySelector('.game-board').getBoundingClientRect();
            
            for (let i = 0; i < 32; i++) {
                const particle = document.createElement('div');
                particle.className = 'explosion-particle';
                
                // éšæœºè¿åŠ¨å‚æ•°
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 120 + 80;
                particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                
                // éšæœºä½ç½®
                particle.style.left = `${Math.random() * boardRect.width}px`;
                particle.style.top = `${Math.random() * boardRect.height}px`;
                
                document.querySelector('.game-board').appendChild(particle);
                
                // è‡ªåŠ¨ç§»é™¤å…ƒç´ 
                setTimeout(() => particle.remove(), 800);
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            // ç§»é™¤åŠ¨ç”»ç±»
            const board = document.querySelector('.game-board');
            board.classList.remove('ending');
            board.style.opacity = '1';
            board.style.transform = 'scale(1)';
            
            // å¯ç”¨æ£‹ç›˜ç‚¹å‡»
            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.pointerEvents = 'auto';
            });
            
            // éšè—å¹¶ç§»é™¤ç»“æŸç•Œé¢
            const gameOver = document.querySelector('.game-over');
            if (gameOver) {
                gameOver.remove();
            }
            
            // ç§»é™¤åŠ¨ç”»ç±»
            const board = document.querySelector('.game-board');
            board.classList.remove('ending');
            board.style.opacity = '1';
            board.style.transform = 'scale(1)';
            
            // å¯ç”¨æ£‹ç›˜ç‚¹å‡»
            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.pointerEvents = 'auto';
            });
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            game.init();
            updateGameView();
        }
        
        // ç²’å­æ•ˆæœç”Ÿæˆå™¨
        function createParticleEffect() {
            const boardRect = gameBoard.getBoundingClientRect();
            
            for (let i = 0; i < 32; i++) {
                const particle = document.createElement('div');
                particle.className = 'explosion-particle';
                
                // éšæœºè¿åŠ¨å‚æ•°
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 120 + 80;
                particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                
                // éšæœºä½ç½®
                particle.style.left = `${Math.random() * boardRect.width}px`;
                particle.style.top = `${Math.random() * boardRect.height}px`;
                
                gameBoard.appendChild(particle);
                
                // è‡ªåŠ¨ç§»é™¤å…ƒç´ 
                setTimeout(() => particle.remove(), 800);
            }
        }

        // å•ä¸ªç å­æ¶ˆé™¤æ—¶çš„çˆ†ç‚¸æ•ˆæœ
        function createExplosionEffect(cell, count) {
            for(let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                const angle = (Math.PI * 2 * i) / 8;
                particle.className = 'explosion-particle';
                particle.style.setProperty('--dx', Math.cos(angle));
                particle.style.setProperty('--dy', Math.sin(angle));
                particle.style.left = `${cell.offsetWidth/2 -4}px`;
                particle.style.top = `${cell.offsetHeight/2 -4}px`;
                cell.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('startGame').addEventListener('click', () => {
            menu.style.display = 'none';
            gameScreen.style.display = 'flex';
            game = new Game();
            game.init();
            initializeBoard();
            updateGameView();
        });

        document.getElementById('backToMenu').addEventListener('click', () => {
            gameScreen.style.display = 'none';
            menu.style.display = 'block';
        });

        // åˆ›å»ºä¸‹æ‹‰é¢æ¿
        function createPanel(title, content) {
            const panel = document.createElement('div');
            panel.className = 'ios-panel';
            panel.innerHTML = `
                <div class="panel-content">
                    <div class="panel-header">
                        <div class="panel-title">${title}</div>
                        <button class="panel-close">å®Œæˆ</button>
                    </div>
                    <div class="panel-body">${content}</div>
                </div>
            `;
            document.body.appendChild(panel);

            // æ·»åŠ åŠ¨ç”»
            requestAnimationFrame(() => {
                panel.classList.add('show');
            });

            // å…³é—­æŒ‰é’®äº‹ä»¶
            panel.querySelector('.panel-close').addEventListener('click', () => {
                panel.classList.remove('show');
                setTimeout(() => panel.remove(), 300);
            });

            // æ»‘åŠ¨å…³é—­
            let startY = 0;
            panel.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });

            panel.addEventListener('touchmove', (e) => {
                const deltaY = e.touches[0].clientY - startY;
                if (deltaY > 0) {
                    panel.style.transform = `translateY(${deltaY}px)`;
                }
            });

            panel.addEventListener('touchend', (e) => {
                const deltaY = e.changedTouches[0].clientY - startY;
                if (deltaY > 100) {
                    panel.classList.remove('show');
                    setTimeout(() => panel.remove(), 300);
                } else {
                    panel.style.transform = '';
                }
            });
        }

        document.getElementById('showRules').addEventListener('click', () => {
            const rulesContent = `
                <div class="rules-list">
                    <div class="rule-item">
                        <div class="rule-number">1</div>
                        <div class="rule-text">æ¯å›åˆå¯ä»¥ç§»åŠ¨ä¸€ä¸ªç å­åˆ°ç©ºä½ç½®</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-number">2</div>
                        <div class="rule-text">æ¯æ¬¡ç§»åŠ¨åä¼šéšæœºå‡ºç°3ä¸ªæ–°ç å­</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-number">3</div>
                        <div class="rule-text">å°†5ä¸ªæˆ–æ›´å¤šç›¸åŒé¢œè‰²çš„ç å­è¿æˆä¸€çº¿å³å¯æ¶ˆé™¤</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-number">4</div>
                        <div class="rule-text">æ¶ˆé™¤çš„ç å­è¶Šå¤šï¼Œè·å¾—çš„åˆ†æ•°è¶Šé«˜</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-number">5</div>
                        <div class="rule-text">å½“æ£‹ç›˜ç©ºä½å°‘äº3ä¸ªæ—¶æ¸¸æˆç»“æŸ</div>
                    </div>
                </div>
            `;
            createPanel('æ¸¸æˆè§„åˆ™', rulesContent);
        });

        document.getElementById('showSettings').addEventListener('click', () => {
            window.location.href = 'settings.html';
        });

        document.getElementById('showRanking').addEventListener('click', () => {
            const rankingContent = `
                <div class="ranking-content">
                    <div class="ranking-message">
                        <div class="message-icon">ğŸ†</div>
                        <div class="message-text">æ¸¸æˆæ’è¡ŒåŠŸèƒ½å³å°†æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼</div>
                    </div>
                </div>
            `;
            createPanel('æ¸¸æˆæ’è¡Œ', rankingContent);
        });
    </script>
</body>
</html>